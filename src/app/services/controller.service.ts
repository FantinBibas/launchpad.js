import {Injectable} from '@angular/core';
import {MidiService} from './midi.service';

@Injectable({
  providedIn: 'root'
})
export class ControllerService {
  printableCharacters: {[key: string]: number[][]} = {
    a: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 1, 1, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
    ],
    b: [
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 1, 1, 0],
    ],
    c: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 0, 0],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    d: [
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 1, 1, 0],
    ],
    e: [
      [1, 1, 1, 1],
      [1, 0, 0, 0],
      [1, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 1, 1, 1],
    ],
    f: [
      [1, 1, 1, 1],
      [1, 0, 0, 0],
      [1, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 0, 0, 0],
    ],
    g: [
      [0, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 0, 1, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    h: [
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 1, 1, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
    ],
    i: [
      [1],
      [1],
      [1],
      [1],
      [1],
    ],
    j: [
      [0, 0, 0, 1],
      [0, 0, 0, 1],
      [0, 0, 0, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    k: [
      [1, 0, 0, 1],
      [1, 0, 1, 0],
      [1, 1, 0, 0],
      [1, 0, 1, 0],
      [1, 0, 0, 1],
    ],
    l: [
      [1, 0, 0, 0],
      [1, 0, 0, 0],
      [1, 0, 0, 0],
      [1, 0, 0, 0],
      [1, 1, 1, 1],
    ],
    m: [
      [1, 0, 0, 1],
      [1, 1, 1, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
    ],
    n: [
      [1, 0, 0, 1],
      [1, 1, 0, 1],
      [1, 0, 1, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
    ],
    o: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    p: [
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 0, 0, 0],
    ],
    q: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 1, 1],
      [0, 1, 1, 1],
    ],
    r: [
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 1, 1, 0],
      [1, 0, 1, 0],
      [1, 0, 0, 1],
    ],
    s: [
      [0, 1, 1, 1],
      [1, 0, 0, 0],
      [0, 1, 1, 0],
      [0, 0, 0, 1],
      [1, 1, 1, 0],
    ],
    t: [
      [1, 1, 1],
      [0, 1, 0],
      [0, 1, 0],
      [0, 1, 0],
      [0, 1, 0],
    ],
    u: [
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    v: [
      [1, 0, 1],
      [1, 0, 1],
      [1, 0, 1],
      [1, 0, 1],
      [0, 1, 0],
    ],
    w: [
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 1, 1, 1],
      [1, 0, 0, 1],
    ],
    x: [
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 0, 1],
    ],
    y: [
      [1, 0, 1],
      [1, 0, 1],
      [1, 1, 1],
      [0, 1, 0],
      [0, 1, 0],
    ],
    z: [
      [1, 1, 1, 1],
      [0, 0, 0, 1],
      [0, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 1, 1, 1],
    ],
    0: [
      [0, 1, 1, 0],
      [1, 0, 1, 1],
      [1, 1, 0, 1],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    1: [
      [0, 1],
      [1, 1],
      [0, 1],
      [0, 1],
      [0, 1],
    ],
    2: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [0, 0, 1, 0],
      [0, 1, 0, 0],
      [1, 1, 1, 1],
    ],
    3: [
      [1, 1, 1, 0],
      [0, 0, 0, 1],
      [0, 1, 1, 0],
      [0, 0, 0, 1],
      [1, 1, 1, 1],
    ],
    4: [
      [1, 0, 0, 1],
      [1, 0, 0, 1],
      [1, 1, 1, 1],
      [0, 0, 0, 1],
      [0, 0, 0, 1],
    ],
    5: [
      [1, 1, 1, 1],
      [1, 0, 0, 0],
      [1, 1, 1, 0],
      [0, 0, 0, 1],
      [1, 1, 1, 0],
    ],
    6: [
      [0, 1, 1, 0],
      [1, 0, 0, 0],
      [1, 1, 1, 0],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    7: [
      [1, 1, 1, 1],
      [0, 0, 0, 1],
      [0, 0, 1, 0],
      [0, 0, 1, 0],
      [0, 0, 1, 0],
    ],
    8: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    9: [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [0, 1, 1, 1],
      [0, 0, 0, 1],
      [0, 1, 1, 0],
    ],
    '.': [
      [0],
      [0],
      [0],
      [0],
      [1],
    ],
    ',': [
      [0, 0],
      [0, 0],
      [0, 0],
      [0, 1],
      [1, 0],
    ],
    '"': [
      [1, 0, 1],
      [1, 0, 1],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
    ],
    '\'': [
      [1],
      [1],
      [0],
      [0],
      [0],
    ],
    '?': [
      [1, 1, 0],
      [0, 0, 1],
      [0, 1, 0],
      [0, 0, 0],
      [0, 1, 0],
    ],
    '!': [
      [1],
      [1],
      [1],
      [0],
      [1],
    ],
    '@': [
      [0, 1, 1, 0],
      [1, 0, 0, 1],
      [1, 0, 1, 1],
      [1, 0, 0, 0],
      [0, 1, 1, 1],
    ],
    _: [
      [0, 0, 0, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
      [1, 1, 1, 1],
    ],
    '*': [
      [1, 0, 0, 1],
      [0, 1, 1, 0],
      [1, 1, 1, 1],
      [0, 1, 1, 0],
      [1, 0, 0, 1],
    ],
    '#': [
      [1, 0, 1, 0],
      [1, 1, 1, 1],
      [1, 0, 1, 0],
      [1, 1, 1, 1],
      [1, 0, 1, 0],
    ],
    $: [
      [0, 1, 1, 1],
      [1, 0, 1, 0],
      [0, 1, 1, 0],
      [0, 1, 0, 1],
      [1, 1, 1, 0],
    ],
    '%': [
      [1, 1, 0, 0],
      [0, 0, 0, 1],
      [0, 1, 1, 0],
      [1, 0, 0, 0],
      [0, 0, 1, 1],
    ],
    '&': [
      [0, 1, 0, 0],
      [1, 0, 1, 0],
      [0, 1, 0, 0],
      [1, 0, 1, 0],
      [0, 1, 0, 1],
    ],
    '(': [
      [0, 1],
      [1, 0],
      [1, 0],
      [1, 0],
      [0, 1],
    ],
    ')': [
      [1, 0],
      [0, 1],
      [0, 1],
      [0, 1],
      [1, 0],
    ],
    '+': [
      [0, 0, 0],
      [0, 1, 0],
      [1, 1, 1],
      [0, 1, 0],
      [0, 0, 0],
    ],
    '-': [
      [0, 0, 0],
      [0, 0, 0],
      [1, 1, 1],
      [0, 0, 0],
      [0, 0, 0],
    ],
    '/': [
      [0, 0, 1],
      [0, 0, 1],
      [0, 1, 0],
      [1, 0, 0],
      [1, 0, 0],
    ],
    ':': [
      [0],
      [1],
      [0],
      [1],
      [0],
    ],
    ';': [
      [0],
      [1],
      [0],
      [1],
      [1],
    ],
    '<': [
      [0, 0, 1],
      [0, 1, 0],
      [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1],
    ],
    '=': [
      [0, 0, 0],
      [1, 1, 1],
      [0, 0, 0],
      [1, 1, 1],
      [0, 0, 0],
    ],
    '>': [
      [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1],
      [0, 1, 0],
      [1, 0, 0],
    ],
    '[': [
      [1, 1],
      [1, 0],
      [1, 0],
      [1, 0],
      [1, 1],
    ],
    '\\': [
      [1, 0, 0],
      [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1],
      [0, 0, 1],
    ],
    ']': [
      [1, 1],
      [0, 1],
      [0, 1],
      [0, 1],
      [1, 1],
    ],
    '^': [
      [0, 1, 0],
      [1, 0, 1],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
    ],
    '`': [
      [1, 0],
      [0, 1],
      [0, 0],
      [0, 0],
      [0, 0],
    ],
    '{': [
      [0, 1, 1],
      [0, 1, 0],
      [1, 1, 0],
      [0, 1, 0],
      [0, 1, 1],
    ],
    '|': [
      [1],
      [1],
      [0],
      [1],
      [1],
    ],
    '}': [
      [1, 1, 0],
      [0, 1, 0],
      [0, 1, 1],
      [0, 1, 0],
      [1, 1, 0],
    ],
    '~': [
      [0, 0, 0, 0],
      [0, 1, 0, 1],
      [1, 0, 1, 0],
      [0, 0, 0, 0],
      [0, 0, 0, 0],
    ],
    ' ': [
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
    ],
  };
  colorCodes: {[key: number]: {r: number, g: number, b: number, a: number}} = {
    0: {r: 0, g: 0, b: 0, a: 0},
    1: {r: 255, g: 0, b: 0, a: .3},
    2: {r: 255, g: 0, b: 0, a: .6},
    3: {r: 255, g: 0, b: 0, a: 1},
    16: {r: 0, g: 255, b: 0, a: .3},
    17: {r: 255, g: 128, b: 0, a: .3},
    18: {r: 255, g: 128, b: 0, a: .6},
    19: {r: 255, g: 85, b: 0, a: 1},
    32: {r: 0, g: 255, b: 0, a: .6},
    33: {r: 128, g: 255, b: 0, a: .6},
    34: {r: 255, g: 255, b: 0, a: .6},
    35: {r: 255, g: 128, b: 0, a: 1},
    48: {r: 0, g: 255, b: 0, a: 1},
    49: {r: 85, g: 255, b: 0, a: 1},
    50: {r: 128, g: 255, b: 0, a: 1},
    51: {r: 255, g: 255, b: 0, a: 11}
  };
  colors = [
    {r: 0, g: 0, b: 0, a: 0, code: 0},
    {r: 255, g: 0, b: 0, a: .3, code: 1},
    {r: 255, g: 0, b: 0, a: .6, code: 2},
    {r: 255, g: 0, b: 0, a: 1, code: 3},
    {r: 0, g: 255, b: 0, a: .3, code: 16},
    {r: 255, g: 128, b: 0, a: .3, code: 17},
    {r: 255, g: 128, b: 0, a: .6, code: 18},
    {r: 255, g: 85, b: 0, a: 1, code: 19},
    {r: 0, g: 255, b: 0, a: .6, code: 32},
    {r: 128, g: 255, b: 0, a: .6, code: 33},
    {r: 255, g: 255, b: 0, a: .6, code: 34},
    {r: 255, g: 128, b: 0, a: 1, code: 35},
    {r: 0, g: 255, b: 0, a: 1, code: 48},
    {r: 85, g: 255, b: 0, a: 1, code: 49},
    {r: 128, g: 255, b: 0, a: 1, code: 50},
    {r: 255, g: 255, b: 0, a: 1, code: 51}
  ];
  scenes: {[key: string]: number[][]} = {};

  constructor(
    private midiService: MidiService
  ) {
  }

  initDevice(deviceId: string): void {
    this.scenes[deviceId] = [
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0, 0]
    ];
    this.midiService.resetColors(deviceId);
  }

  drawCharToGridPosition(outputId: string, x: number, y: number, char: string, fontColor: number, backgroundColor: number = 0): void {
    char = char.toLowerCase();
    if (Object.keys(this.printableCharacters).includes(char)) {
      this.midiService.drawToGridPosition(outputId, x, y,
        this.printableCharacters[char].map(line => line.map(pixel => pixel ? fontColor : backgroundColor))
      );
    }
  }

  drawTextToGridPosition(outputId: string, x: number, y: number, text: string, fontColor: number, backgroundColor: number = 0): number {
    let firstLetter = true;

    for (let letter of text) {
      letter = letter.toLowerCase();
      if (!Object.keys(this.printableCharacters).includes(letter)) {
        letter = ' ';
      }
      if (!firstLetter) {
        this.midiService.drawToGridPosition(outputId, x, y,
          [[backgroundColor], [backgroundColor], [backgroundColor], [backgroundColor], [backgroundColor]]
        );
        x += 1;
      }
      this.drawCharToGridPosition(outputId, x, y, letter, fontColor, backgroundColor);
      x += this.printableCharacters[letter][0].length;
      firstLetter = false;
    }
    return x;
  }

  scrollTextOnGrid(
    outputId: string, text: string, fontColor: number, backgroundColor: number = 0, scrollInterval = 300, y: number = 0
  ): void {
    let interval: number;
    let offset = 0;

    interval = setInterval(() => {
      const endOffset = this.drawTextToGridPosition(outputId, offset, y, text, fontColor, backgroundColor);
      offset -= 1;
      if (endOffset <= 0 && interval) {
        clearInterval(interval);
      }
    }, scrollInterval);
  }
}
